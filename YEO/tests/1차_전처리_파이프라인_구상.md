# 🎯 최종 전처리 파이프라인 (MVP, 8초 세그먼트)

버전: 2025-08-25 (KST)

## 0) 변경 사항 요약 (이번 수정)
- **긴 발화 처리 규칙 명시**: 8초 기준 `⌊L/8⌋`개로 분할, **잔여 ≥ 4초**이면 zero-pad해 8초로 추가, **< 4초**면 폐기.
- **집계(aggregation) 전략**: 세그먼트 softmax **평균**으로 발화 레벨 감정 산출. 동률/불안정 시 **최대 신뢰도 세그먼트**로 보정.
- **MVP 원칙**: 오버랩/슬라이딩 윈도우는 **생략**(복잡도 절감). 추후 고도화 항목으로 보류.

---

## 1) CSV/라벨 정제
- 컬럼 이름 표준화: 예) `4번감정세기` → `4번 감정세기` 등 오탈자 수정.
- 감정 라벨 표준화: `Sadness/sadness/sad` → `sad` 등.
- **final_emotion 생성**:
  - 어노테이터 5명 다수결.
  - **동률(TIE)**이면 `상황` 1표 추가해 재투표.
  - 여전히 동률이면 `TIE` 확정 → **drop**.

## 2) 데이터 품질 필터링 (EDA 기반)
- 최종 규칙:
  - `agreement_ratio ≥ 0.6`
  - `duration ≥ 0.2s`
  - `snr_proxy_db ≥ 10 dB`
  - `crest ≤ 30`
  - `clipping_ratio ≤ 0.01`
- **필터링 결과 (확정)**
  - 원본: **42,408**
  - 필터링 후: **36,467**
  - 제외: **5,941** (약 **14%**)
- **필터링 후 클래스 분포**
  - sad **15,410**
  - angry **6,913**
  - neutral **5,415**
  - happiness **3,457**
  - fear **2,455**
  - disgust **2,091**
  - surprise **726**
- 시사점: 소수 클래스(특히 **surprise, disgust, fear**) 감소 → **class weight/oversampling** 필요.

## 3) 오디오 포맷 통일
- 입력 포맷: **16kHz, mono, float32, [-1,1] normalize**
- 원본이 48kHz인 경우 resample.

## 4) 길이 규격화 (핵심)
- **고정 길이 = 8초** (데이터 분포상 2~8초 집중, 계산량·정보량 균형점)
- 짧은 발화 `< 8s`: **center pad** (zero-padding) → 8초 정규화
- 긴 발화 `> 8s`: **분할 규칙 적용**

### 4-1) 긴 발화 분할 규칙 (MVP)
- 발화 길이 `L`에 대해:
  1) **정수 세그먼트**: `k = ⌊L / 8⌋` → **k개 × 8초** 세그먼트 생성 (순차 분할, **오버랩 없음**)
  2) **잔여 처리**: `r = L % 8`
     - `r ≥ 4s` → **pad**하여 8초 세그먼트 **추가**
     - `r < 4s` → **폐기** (노이즈/정보량 부족)
- **정렬 규칙**: 좌→우 순서 분할(시간 순서 유지). Center-crop은 **단발 발화(>8s≤16s) 한정 옵션**으로만 사용 가능하나, 기본은 **순차 분할**.

### 4-2) 발화 경계 기준
- **우선순위**: (1) STT timestamp 기반 발화 경계 → (2) VAD 기반 경계 → (3) 경계정보 없으면 **균일 8초 타일링**.
- 경계가 있는 경우: **발화 경계 내부에서만** 8초 분할/패딩 수행.

## 5) 모델 입력별 전처리
- **wav2vec2/HuBERT 등 SSL 계열**: raw-wave(16k) 그대로. 선택적 **peak normalize / silence trim**.
- **CNN/CRNN baseline**: log-mel (예: n_mels=128, win=25ms, hop=10ms), per-utterance CMVN, **SpecAugment(Optional)**.

## 6) 세그먼트→발화 집계 (Inference Aggregation)
- 발화 레벨 확정값 = 세그먼트 softmax **평균** (class-wise mean)
- **보정 규칙**:
  - 평균 확률 상위 2개가 근접(예: Δ<0.05)일 땐, **최대 신뢰도(top-1 확률 최대) 세그먼트**로 결정.
  - 세그먼트 수가 1개뿐이면 그 결과를 사용.
- (옵션) 신뢰도 메타: 세그먼트 간 **분산**, 최종 **entropy** 로그로 저장.

## 7) 클래스 불균형 대응
- **필수**: `class_weight` 또는 `WeightedRandomSampler`.
- (옵션) 소수 클래스 **oversampling/augmentation** (noise, gain, pitch shift, time-stretch 등; 과도한 변형 금지).

## 8) Dataloader & 재현성
- **collate_fn**에서 길이 정규화(8초 pad/trunc) 보장.
- 세그먼트 샘플에는 원발화 ID/세그먼트 인덱스 메타를 동봉(집계·리포트용).
- seed 고정, 데이터셋 스플릿 고정(화자 분리 권장).

## 9) 평가/리포트 기준
- 지표: macro-F1, weighted-F1, per-class F1, confusion matrix.
- **두 단계 평가**: (1) 세그먼트 레벨, (2) 발화 레벨(집계 적용).
- 리포트: 클래스별 샘플 수/정확도, 불균형 보정 효과, 품질 플래그 샘플 제거 영향.

## 10) 서비스 연동 메모 (MVP UX)
- 사용자 안내: “**분석은 최대 8초 단위로 수행**됩니다. 더 길게 말씀하셔도 핵심 구간을 사용합니다.”
- 서버 부하 완화: 업로드 직후 **미디어 길이 산출 → 분할/패딩 큐잉**.
- 로깅: 각 세그먼트의 예측/신뢰도/타임스탬프 저장 → 일/주간 카드 생성에 활용.

## 11) 고도화 로드맵 (후순위)
- 슬라이딩 윈도우(예: 8s / stride 4s) + 중첩 집계 실험.
- 통계/어텐션 풀링 헤드로 **가변 길이 직접 처리** 전환.
- 멀티모달(표정·STT) **시점 정렬** 및 late fusion.

---

### 부록 A) 데이터셋 크기 요약
- 원본: 43,991 → TIE 제거·누락 drop 후 **42,408**
- 품질 필터링 후: **36,467**

### 부록 B) 체크리스트 (QA용)
- [ ] 16kHz/mono 변환 확인
- [ ] 8초 규격화(분할·패딩) 일관 동작
- [ ] 잔여 처리 규칙(≥4s pad, <4s drop) 적용
- [ ] 세그먼트 메타(원발화 ID, idx) 동봉
- [ ] 집계 로직(평균 + 보정) 적용
- [ ] class weight/샘플러 적용
- [ ] 리포트에 세그먼트/발화 레벨 지표 포함

